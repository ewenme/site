{{ $title := cond .IsHome .Site.Title (printf "%s | %s" (.Title | title ) .Site.Title) }}
{{ $permalink := .Permalink }}
{{ $page := . }}                           <!--save current page-->
{{ $section := $page.CurrentSection }}     <!--save branch section-->

<head>
  <meta charset="utf-8">
  <title>{{ $title }}</title>

  {{ with default .Site.Params.Description .Description  }}
    <meta name="description" content="{{ . }}">
    <meta name="og:description" content="{{ . }}">
    <meta name="twitter:description" content="{{ . }}">
  {{ end }}

  {{ with .Site.Params.author.twitterHandle }}
    <meta name="twitter:site" content="@{{ . }}">
  {{ end }}

  <meta property="twitter:title" content="{{ $title }}">
  {{ template "_internal/twitter_cards.html" . }}

  <!--sharing images-->
<!--adapted from: https://github.com/kaushalmodi/hugo-bare-min-theme/blob/6195b5e377c56791ba4067ac0ec5286bf336aedf/layouts/partials/twitter_cards.html-->

<!--default sharing image-->
{{- $site_card := printf "%s" site.Params.sharing_image | absURL }}

{{/* If images are specified as list variable in section front matter. */}}
{{- with $.Params.images -}}
    <meta name="twitter:card" content="summary_large_image"/>
    {{- $image := (index . 0) -}}
    {{- $image_link_absolute := (findRE "^/" $image) -}}
    {{- if $image_link_absolute -}}
        <meta name="twitter:image" content="{{- $image | absURL -}}"/>
    {{- else -}}
        <meta name="twitter:image" content="{{- (printf "%s%s" $permalink $image) -}}"/>
    {{- end -}}
<!--using featured images-->
{{ else -}}
    <!--featured image for the leaf bundle-->
    {{- $images := $page.Resources.ByType "image" -}}
    {{ $leaf := $images.GetMatch "*feature*" }}
    {{- $hex := $images.GetMatch "*hex*" -}}
    {{- $card := cond (ne $hex nil) $hex $leaf -}}
    <!--sidebar image for the branch bundle-->
    {{ $branch := ($section.Resources.ByType "image").GetMatch "*sidebar*" }}
    {{- $card := cond (ne $card nil) $card $branch -}}
    {{ with $card }}
        <meta property="og:image" content="{{ .Permalink }}" >
        <meta property="twitter:card" content="{{ if (ne $hex nil) }}summary{{ else }}summary_large_image{{ end }}">
        <meta name="twitter:image" content="{{ .Permalink }}" >
    <!--if no featured, use the site card-->
    {{ else }}
        <meta property="og:image" content="{{ $site_card }}" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="{{ $site_card }}" >
    {{ end }}
{{- end -}}

  <meta property="og:locale" content="{{ .Site.Language.Lang }}">
  <meta property="og:title" content="{{ $title }}">
  <meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
  {{ range .Params.tags }}
    <meta property="article:section" content="{{ . }}">
  {{ end }}
  {{ if isset .Params "date" }}
    <meta property="article:published_time" content="{{ time .Date }}">
  {{ end }}
  <meta property="og:url" content="{{ .Permalink }}">
  <meta property="og:site_name" content="{{ .Site.Title }}">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#fff">

  {{ with .OutputFormats.Get "RSS" }}
    <link href="{{ .RelPermalink }}" rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}">
    <link href="{{ .RelPermalink }}" rel="feed" type="application/rss+xml" title="{{ $.Site.Title }}">
  {{ end }}

  {{ with .Params.prev }}
    <link rel="prev" href="{{ . | absURL }}">
  {{ end }}
  {{ with .Params.next }}
    <link rel="next" href="{{ . | absURL }}">
  {{ end }}

  {{ if .IsPage }}
    {{ if .NextInSection }}
      <link rel="prefetch" href="{{ .NextInSection.Permalink }}">
    {{ end }}

    {{ if .PrevInSection }}
      <link rel="prefetch" href="{{ .PrevInSection.Permalink }}">
    {{ end }}
  {{ end }}

  {{ with .Params.canonical }}
    <link href="{{ . }}" rel="canonical" />
  {{ end }}

  <link rel="icon" type="image/png" href="/favicon.ico"/>
  <link rel="manifest" href="/site.webmanifest">

  {{ $postCSSConfig := (dict "config" "postcss.config.js") }}

  {{ range .Params.html_dependencies }}
  {{ . | safeHTML }}
{{ end }}

  {{ if .Site.IsServer }}
    {{ $css := resources.Get "css/main.css" | toCSS | postCSS $postCSSConfig  }}
    <link rel="stylesheet" href="{{ $css.Permalink | relURL }}" media="screen">
  {{ else }}
    {{ $css := resources.Get "css/main.css" | toCSS | postCSS $postCSSConfig | minify | fingerprint }}
    <link rel="stylesheet" href="{{ $css.Permalink | relURL }}" media="screen">
  {{ end }}

  {{ if ne .Page.Kind "404" }}
    {{ if .Site.IsServer }}
      {{ $defines := dict "process.env.NODE_ENV" `"development"` }}
      {{ $opts := dict "defines" $defines }}
      {{ $js := resources.Get "js/main.js" | js.Build $opts }}
      <script src="{{ $js.Permalink | relURL }}" defer></script>
    {{ else }}
      {{ $defines := dict "process.env.NODE_ENV" `"production"` }}
      {{ $opts := dict "defines" $defines }}
      {{ $js := resources.Get "js/main.js" | js.Build $opts | minify | fingerprint }}
      <script src="{{ $js.Permalink | relURL }}" defer></script>
    {{ end }}
  {{ end }}

  {{ if .IsHome }}
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "{{ .Permalink }}",
        "name": "{{ .Site.Title }}",
        "author": {
          "@type": "Person",
          "name": "{{ .Site.Params.author.name }}"
        },
        "description": "{{ .Site.Params.description }}"
      }
    </script>
  {{ end }}
  {{ if .IsPage }}
    <script type="application/ld+json">
     {{ if eq .Section "posts" }}
     {
       "@context": "https://schema.org",
       "@type": "BlogPosting",
       "headline": "{{ .Title }}",
       "keywords": {{ .Params.tags | jsonify }},
       "url": "{{ .Permalink }}",
       "datePublished": "{{ time .Date }}",
       "dateModified": "{{ time .Lastmod }}",
       "description": "{{ .Description }}",
       "wordCount": "{{ .WordCount }}",
       "author": {
         "@type": "Person",
         "name": "{{ .Site.Params.author.name }}"
       }
     }
     {{ else }}
     {
       "@context": "https://schema.org",
       "@type": "WebSite",
       "url": "{{ .Permalink }}",
       "name": "{{ .Title }}",
       "author": {
         "@type": "Person",
         "name": "{{ .Site.Params.author.name }}"
       },
       "description": "{{ .Site.Params.description }}",
     }
     {{ end }}
  </script>
  {{ end }}
  <script>
    try {
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
        document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
      } else {
        document.documentElement.classList.remove('dark')
      }
    } catch (e) {}
  </script>
</head>
